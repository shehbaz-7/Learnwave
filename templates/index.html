{% extends "base.html" %}

{% block title %}Document Repository{% endblock %}

{% block head_extra %}
<style>
    .skeleton-loader { display: block; }
    .data-table-container { display: none; }
    .skeleton-item {
        background: linear-gradient(90deg, var(--bg-tertiary) 25%, #2a2f37 50%, var(--bg-tertiary) 75%);
        background-size: 200% 100%;
        animation: skeleton-shimmer 1.5s infinite linear;
        border-radius: 4px;
        height: 20px;
        width: 100%;
    }
    @keyframes skeleton-shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-database text-primary"></i> Content Repository</h1>
        {% if is_admin %}
        <a href="{{ url_for('main.upload_file') }}" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Upload New Content</a>
        {% endif %}
    </div>
    <div class="card">
        <div class="card-body">
            <div class="skeleton-loader">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Content Name</th>
                                <th>Type</th>
                                <th>Segments/Pages</th>
                                <th>Added On</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(5) %}
                            <tr>
                                <td><div class="skeleton-item" style="width: 80%;"></div></td>
                                <td><div class="skeleton-item" style="width: 40%;"></div></td>
                                <td><div class="skeleton-item" style="width: 30%;"></div></td>
                                <td><div class="skeleton-item" style="width: 70%;"></div></td>
                                <td><div class="skeleton-item" style="width: 60%;"></div></td>
                                <td><div class="skeleton-item" style="width: 90%;"></div></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Content Name</th>
                                <th>Type</th>
                                <th>Segments/Pages</th>
                                <th>Added On</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                            <tr data-doc-id="{{ doc.id }}">
                                <td>
                                    {% if doc.doc_type == 'youtube' %}
                                        <i class="fab fa-youtube text-danger me-2"></i>
                                    {% else %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {% endif %}
                                    <strong>{{ doc.original_filename }}</strong>
                                </td>
                                <td>
                                    {% if doc.doc_type == 'youtube' %}
                                        <span class="badge bg-danger">Video</span>
                                    {% else %}
                                        <span class="badge bg-secondary">PDF</span>
                                    {% endif %}
                                </td>
                                <td class="pages-cell">{{ doc.total_pages if doc.processed else 'N/A' }}</td>
                                <td>{{ doc.upload_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="status-cell">
                                    {% if doc.processed %}
                                        <span class="badge bg-success"><i class="fas fa-check"></i> Processed</span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <span class="spinner-border spinner-border-sm"></span>
                                            <span class="status-text">Queued</span>
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{{ url_for('main.view_document', doc_id=doc.id) }}" class="btn btn-sm btn-outline-primary view-btn {% if not doc.processed %}disabled{% endif %}" target="_blank" rel="noopener noreferrer">View</a>
                                        <button class="btn btn-sm btn-outline-info study-btn {% if not doc.processed %}disabled{% endif %}"
                                                data-bs-toggle="modal" data-bs-target="#studySetModal"
                                                data-doc-id="{{ doc.id }}"
                                                data-doc-filename="{{ doc.original_filename }}">
                                            Study
                                        </button>
                                        <button class="btn btn-sm btn-outline-success generate-path-btn {% if not doc.processed %}disabled{% endif %}"
                                                data-doc-id="{{ doc.id }}"
                                                data-doc-filename="{{ doc.original_filename }}">
                                            Generate Path
                                        </button>
                                        {% if is_admin %}
                                        <form action="{{ url_for('main.delete_document', doc_id=doc.id) }}" method="POST" class="d-inline" data-no-loader>
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this content from all repositories? This cannot be undone.')">Delete</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block modals %}
<div class="modal fade" id="studySetModal" tabindex="-1" aria-labelledby="studySetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studySetModalLabel">Generate Study Set</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="studyOptionsForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label class="form-label">Study Method</label>
                        <div class="btn-group w-100">
                            <input type="radio" class="btn-check" name="setType" id="quiz" value="quiz" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="quiz"><i class="fas fa-question-circle me-2"></i>Quiz</label>
                            <input type="radio" class="btn-check" name="setType" id="flashcards" value="flashcards" autocomplete="off">
                            <label class="btn btn-outline-primary" for="flashcards"><i class="fas fa-clone me-2"></i>Flashcards</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="difficulty" class="form-label">Difficulty Level</label>
                        <select class="form-select" id="difficulty" name="difficulty">
                            <option value="easy">Easy (Definitions & Terms)</option>
                            <option value="medium" selected>Medium (Core Concepts)</option>
                            <option value="hard">Hard (Application & Analysis)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="questionCount" class="form-label">Number of Items: <span id="countValue">10</span></label>
                        <input type="range" class="form-range" id="questionCount" name="count" min="5" max="20" value="10" oninput="document.getElementById('countValue').textContent = this.value">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="generateStudySetBtn" class="btn btn-primary">
                    <i class="fas fa-cogs me-2"></i>Generate & Go to Session
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    setTimeout(() => {
        document.querySelector('.skeleton-loader').style.display = 'none';
        document.querySelector('.data-table-container').style.display = 'block';
    }, 750);

    const eventSource = new EventSource("{{ url_for('main.status_updates') }}");
    eventSource.onmessage = function (event) {
        const statuses = JSON.parse(event.data);
        document.querySelectorAll('tr[data-doc-id]').forEach(row => {
            const docId = row.getAttribute('data-doc-id');
            const statusInfo = statuses[docId];
            if (!statusInfo) return;

            const statusCell = row.querySelector('.status-cell');
            const viewBtn = row.querySelector('.view-btn');
            const studyBtn = row.querySelector('.study-btn');
            const pathBtn = row.querySelector('.generate-path-btn');

            if (statusInfo.complete) {
                if (statusInfo.error) {
                    statusCell.innerHTML = `<span class="badge bg-danger"><i class="fas fa-times"></i> Failed</span>`;
                } else {
                    statusCell.innerHTML = `<span class="badge bg-success"><i class="fas fa-check"></i> Processed</span>`;
                    viewBtn.classList.remove('disabled');
                    studyBtn.classList.remove('disabled');
                    pathBtn.classList.remove('disabled');
                }
            } else {
                const text = statusInfo.text || 'Processing...';
                statusCell.innerHTML = `<span class="badge bg-warning"><span class="spinner-border spinner-border-sm"></span> <span>${text}</span></span>`;
                viewBtn.classList.add('disabled');
                studyBtn.classList.add('disabled');
                pathBtn.classList.add('disabled');
            }
        });
    };

    const studySetModalEl = document.getElementById('studySetModal');
    if (studySetModalEl) {
        let currentDocId = null;
        let currentDocFilename = null;
        const form = document.getElementById('studyOptionsForm');
        const modalInstance = new bootstrap.Modal(studySetModalEl);

        studySetModalEl.addEventListener('click', async function(event) {
            const generateBtn = event.target.closest('#generateStudySetBtn');
            if (!generateBtn) return;

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = Object.fromEntries(new FormData(form).entries());

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Generating...`;
            form.querySelector('.alert')?.remove();

            try {
                const response = await fetch(`/generate_study_set/${currentDocId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok || result.error) throw new Error(result.error || 'Failed to generate study set.');

                const newSet = {
                    id: Date.now(),
                    title: `${data.setType.charAt(0).toUpperCase() + data.setType.slice(1)} (${data.difficulty})`,
                    setType: data.setType,
                    sourceDocId: currentDocId,
                    sourceDocFilename: currentDocFilename,
                    content: result
                };

                const allSets = JSON.parse(localStorage.getItem('myStudySets') || '[]');
                allSets.push(newSet);
                localStorage.setItem('myStudySets', JSON.stringify(allSets));

                // --- START OF FIX ---
                // Listen for the modal to be fully hidden BEFORE navigating
                studySetModalEl.addEventListener('hidden.bs.modal', () => {
                    window.location.href = `/study_session/${newSet.id}`;
                }, { once: true }); // Use 'once' so the listener removes itself

                modalInstance.hide(); // Programmatically hide the modal
                // --- END OF FIX ---

            } catch (error) {
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger mt-3';
                alert.textContent = error.message;
                studySetModalEl.querySelector('.modal-body').appendChild(alert);
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Generate & Go to Session';
            }
        });

        studySetModalEl.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            currentDocId = button.getAttribute('data-doc-id');
            currentDocFilename = button.getAttribute('data-doc-filename');
            studySetModalEl.querySelector('.modal-title').textContent = `Generate Study Set for: ${currentDocFilename}`;
        });

        studySetModalEl.addEventListener('hidden.bs.modal', function () {
            form.reset();
            form.querySelector('.alert')?.remove();
            const generateBtn = document.getElementById('generateStudySetBtn');
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Generate & Go to Session';
        });
    }

    document.querySelector('.data-table-container').addEventListener('click', async function(event) {
        const generateBtn = event.target.closest('.generate-path-btn');
        if (!generateBtn || generateBtn.disabled) return;

        generateBtn.disabled = true;
        generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

        const docId = generateBtn.dataset.docId;
        const docFilename = generateBtn.dataset.docFilename;

        try {
            const response = await fetch(`/learning-path/create-full/${docId}`, { method: 'POST' });
            if (!response.ok && response.status !== 409) {
                const data = await response.json();
                throw new Error(data.error || 'A server error occurred.');
            }

            const allPaths = JSON.parse(localStorage.getItem('myLearningPaths') || '[]');
            let existingPath = allPaths.find(p => p.sourceDocId.toString() === docId);

            if (!existingPath) {
                allPaths.push({
                    id: Date.now(),
                    sourceDocId: docId,
                    sourceDocFilename: docFilename,
                    status: 'generating',
                    pathData: null
                });
                localStorage.setItem('myLearningPaths', JSON.stringify(allPaths));
            } else if (existingPath.status === 'failed') {
                existingPath.status = 'generating';
                localStorage.setItem('myLearningPaths', JSON.stringify(allPaths));
            }

            window.location.href = "{{ url_for('main.my_space') }}";

        } catch (error) {
            console.error('Failed to start learning path generation:', error);
            alert(`Error: ${error.message}`);
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Path';
        }
    });
});
</script>
{% endblock %}
